<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tilbakestill passord - Regnskap</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div id="auth-view" class="auth-container">
        <div class="auth-box">
            <h1>Tilbakestill passord</h1>

            <div id="reset-form" class="auth-form">
                <p id="status-message"></p>
                <form id="newPasswordForm">
                    <div class="form-group">
                        <label for="new-password">Nytt passord</label>
                        <input type="password" id="new-password" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Bekreft passord</label>
                        <input type="password" id="confirm-password" required minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary">Tilbakestill passord</button>
                </form>
                <p class="auth-switch">
                    <a href="/">Tilbake til innlogging</a>
                </p>
            </div>
        </div>
    </div>

    <script type="module">
        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (!token) {
            document.getElementById('status-message').innerHTML =
                '<strong style="color: red;">Ugyldig lenke. Ingen token funnet.</strong>';
            document.getElementById('newPasswordForm').style.display = 'none';
        }

        document.getElementById('newPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                alert('Passordene stemmer ikke overens!');
                return;
            }

            try {
                const response = await fetch('/api/auth/password-reset/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('status-message').innerHTML =
                        '<strong style="color: green;">✓ Passord tilbakestilt! Du kan nå logge inn med ditt nye passord.</strong>';
                    document.getElementById('newPasswordForm').style.display = 'none';

                    // Redirect to login after 3 seconds
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                } else {
                    document.getElementById('status-message').innerHTML =
                        '<strong style="color: red;">Feil: ' + (data.detail || 'Kunne ikke tilbakestille passord') + '</strong>';
                }
            } catch (error) {
                document.getElementById('status-message').innerHTML =
                    '<strong style="color: red;">Feil: ' + error.message + '</strong>';
            }
        });
    </script>
</body>
</html>
